name: Deployment Verification

on:
  push:
    branches: [main]
  workflow_dispatch:
  schedule:
    # Run health checks every 6 hours
    - cron: '0 */6 * * *'

jobs:
  verify-deployment:
    runs-on: ubuntu-latest
    name: Verify UMAJA Deployment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests colorama
      
      - name: Check Backend Health
        id: backend-health
        continue-on-error: true
        run: |
          echo "üîç Checking backend health..."
          
          # Try primary backend (Railway)
          BACKEND_URL="https://umaja-core-production.up.railway.app"
          
          # Wait for cold start (Render/Railway free tier)
          echo "‚è≥ Waiting for backend to wake up (15s timeout)..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 15 "$BACKEND_URL/health" || echo "000")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Backend is healthy!"
            echo "backend_status=healthy" >> $GITHUB_OUTPUT
            echo "$BODY" | jq '.' || echo "$BODY"
          else
            echo "‚ùå Backend health check failed (HTTP $HTTP_CODE)"
            echo "backend_status=unhealthy" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Test Daily Smile Endpoint
        if: steps.backend-health.outputs.backend_status == 'healthy'
        id: daily-smile
        continue-on-error: true
        run: |
          echo "üîç Testing /api/daily-smile endpoint..."
          
          BACKEND_URL="${{ steps.backend-health.outputs.backend_url }}"
          RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 10 "$BACKEND_URL/api/daily-smile" || echo "000")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Daily smile endpoint working!"
            echo "smile_status=working" >> $GITHUB_OUTPUT
            echo "$BODY" | jq '.content' || echo "$BODY"
          else
            echo "‚ùå Daily smile endpoint failed (HTTP $HTTP_CODE)"
            echo "smile_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Test Generate Endpoint
        if: steps.backend-health.outputs.backend_status == 'healthy'
        id: generate
        continue-on-error: true
        run: |
          echo "üîç Testing POST to backend..."
          
          BACKEND_URL="${{ steps.backend-health.outputs.backend_url }}"
          
          # Test smile by archetype
          for ARCHETYPE in professor worrier enthusiast; do
            echo "Testing archetype: $ARCHETYPE"
            RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 10 "$BACKEND_URL/api/smile/$ARCHETYPE" || echo "000")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "  ‚úÖ $ARCHETYPE archetype working"
            else
              echo "  ‚ùå $ARCHETYPE archetype failed (HTTP $HTTP_CODE)"
            fi
          done
          
          echo "generate_status=tested" >> $GITHUB_OUTPUT
      
      - name: Check Frontend Deployment
        id: frontend
        continue-on-error: true
        run: |
          echo "üîç Checking GitHub Pages frontend..."
          
          FRONTEND_URL="https://harrie19.github.io/UMAJA-Core/"
          RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 10 "$FRONTEND_URL" || echo "000")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Frontend is accessible!"
            echo "frontend_status=accessible" >> $GITHUB_OUTPUT
            
            # Check if page contains expected content
            if echo "$BODY" | grep -q "UMAJA"; then
              echo "‚úÖ Frontend contains UMAJA branding"
            else
              echo "‚ö†Ô∏è  Warning: Frontend may not have loaded correctly"
            fi
          else
            echo "‚ùå Frontend check failed (HTTP $HTTP_CODE)"
            echo "frontend_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Generate Summary
        if: always()
        run: |
          echo "## üåç UMAJA Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mission**: Bringing smiles to 8 billion people" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Backend Status
          echo "### üöÇ Backend (Railway)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.backend-health.outputs.backend_status }}" = "healthy" ]; then
            echo "‚úÖ **Status**: Healthy (HTTP ${{ steps.backend-health.outputs.http_code }})" >> $GITHUB_STEP_SUMMARY
            echo "üîó **URL**: ${{ steps.backend-health.outputs.backend_url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Status**: Unhealthy" >> $GITHUB_STEP_SUMMARY
            echo "üîó **URL**: ${{ steps.backend-health.outputs.backend_url }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # API Endpoints
          echo "### üîå API Endpoints" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.daily-smile.outputs.smile_status }}" = "working" ]; then
            echo "‚úÖ `/api/daily-smile` - Working" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå `/api/daily-smile` - Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.generate.outputs.generate_status }}" = "tested" ]; then
            echo "‚úÖ `/api/smile/<archetype>` - Tested" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è  `/api/smile/<archetype>` - Not tested" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Frontend Status
          echo "### üåê Frontend (GitHub Pages)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.frontend.outputs.frontend_status }}" = "accessible" ]; then
            echo "‚úÖ **Status**: Accessible (HTTP ${{ steps.frontend.outputs.http_code }})" >> $GITHUB_STEP_SUMMARY
            echo "üîó **URL**: ${{ steps.frontend.outputs.frontend_url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Status**: Failed" >> $GITHUB_STEP_SUMMARY
            echo "üîó **URL**: ${{ steps.frontend.outputs.frontend_url }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall Status
          echo "### üìä Overall Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.backend-health.outputs.backend_status }}" = "healthy" ] && \
             [ "${{ steps.frontend.outputs.frontend_status }}" = "accessible" ]; then
            echo "üéâ **UMAJA IS LIVE!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "_Serving 8 billion people with Truth, Unity, and Service_ ‚ú®" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è  **Deployment Issues Detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Troubleshooting**:" >> $GITHUB_STEP_SUMMARY
            echo "- Check workflow logs for error details" >> $GITHUB_STEP_SUMMARY
            echo "- Verify Railway deployment status" >> $GITHUB_STEP_SUMMARY
            echo "- Check GitHub Pages deployment" >> $GITHUB_STEP_SUMMARY
            echo "- Review recent commits for breaking changes" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Last checked: $(date -u '+%Y-%m-%d %H:%M:%S UTC')_" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify on Failure
        if: failure()
        run: |
          echo "‚ö†Ô∏è  Deployment verification failed!"
          echo "Check the job summary for details."
          echo ""
          echo "This could indicate:"
          echo "  - Backend is down or unhealthy"
          echo "  - Frontend failed to deploy"
          echo "  - API endpoints are not responding"
          echo ""
          echo "Review the logs above and take appropriate action."
          exit 1
