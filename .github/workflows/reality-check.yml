name: Reality Check Monitor

on:
  # Schedule: Every 6 hours
  schedule:
    - cron: '0 */6 * * *'
  
  # Manual trigger
  workflow_dispatch:
  
  # Push trigger for relevant files
  push:
    paths:
      - 'src/**'
      - 'api/**'
      - 'docs/config.js'
      - 'src/reality_agent.py'
      - '.github/workflows/reality-check.yml'

permissions:
  contents: read
  issues: write

jobs:
  reality-check:
    name: Reality Glasses Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
      
      - name: üêç Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ü•Ω Run Reality Agent
        id: reality-check
        continue-on-error: true
        run: |
          echo "Running Reality Agent..."
          python src/reality_agent.py
          
          # Capture exit code
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Find the latest JSON report
          LATEST_JSON=$(ls -t data/reality_checks/*.json | head -1)
          echo "report_path=$LATEST_JSON" >> $GITHUB_OUTPUT
          
          # Extract overall status
          OVERALL_STATUS=$(python -c "import json; print(json.load(open('$LATEST_JSON'))['overall_status'])")
          echo "overall_status=$OVERALL_STATUS" >> $GITHUB_OUTPUT
          
          # Exit with agent's exit code
          exit $EXIT_CODE
      
      - name: üìä Generate GitHub Summary
        if: always()
        run: |
          echo "# ü•Ω Reality Check Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Status:** ${{ steps.reality-check.outputs.overall_status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Find the latest report
          LATEST_JSON=$(ls -t data/reality_checks/*.json | head -1)
          LATEST_MD=$(ls -t data/reality_checks/*.md | head -1)
          
          if [ -f "$LATEST_JSON" ]; then
            echo "## üìã Check Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Parse JSON and display results
            python << 'PYTHON_SCRIPT'
          import json
          import sys
          
          latest_json = "$LATEST_JSON"
          with open(latest_json.replace('$', '\$'), 'r') as f:
              data = json.load(f)
          
          with open(str(sys.getenv('GITHUB_STEP_SUMMARY')), 'a') as summary:
              for check in data['checks']:
                  status_emoji = {
                      'OK': '‚úÖ',
                      'WARNING': '‚ö†Ô∏è',
                      'CRITICAL': 'üö®',
                      'ERROR': '‚ùå'
                  }
                  emoji = status_emoji.get(check['status'], '‚ùì')
                  
                  summary.write(f"### {emoji} {check['name']}\n\n")
                  summary.write(f"**Status:** {check['status']}  \n")
                  summary.write(f"**Confidence:** {check['confidence']:.0%}  \n")
                  summary.write(f"**Message:** {check['message']}\n\n")
                  
                  # Add key details
                  if check['name'] == 'Bug Scan' and 'summary' in check['details']:
                      summary.write(f"**Issues Found:**\n")
                      for key, value in check['details']['summary'].items():
                          if value > 0:
                              summary.write(f"- {key.replace('_', ' ').title()}: {value}\n")
                      summary.write("\n")
                  
                  summary.write("---\n\n")
              
              summary.write("## ü•Ω Reality Glasses Philosophy\n\n")
              summary.write("- ‚úÖ **PROACTIVE** - Scanned before problems reported\n")
              summary.write("- ‚úÖ **VERIFY** - Checked facts, didn't guess\n")
              summary.write("- ‚úÖ **TRUTH** - Measured reality with confidence scores\n")
              summary.write("- ‚úÖ **REALITY** - Used sensors, not assumptions\n\n")
          PYTHON_SCRIPT
          
            echo "Report saved to: $LATEST_JSON"
          else
            echo "‚ö†Ô∏è No report found" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: üì¶ Upload Results as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reality-check-results-${{ github.run_number }}
          path: data/reality_checks/
          retention-days: 30
      
      - name: üö® Create GitHub Issue on Critical Status
        if: always() && steps.reality-check.outputs.overall_status == 'CRITICAL'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Find latest JSON report
            const reportsDir = 'data/reality_checks';
            const files = fs.readdirSync(reportsDir)
              .filter(f => f.endsWith('.json'))
              .map(f => ({
                name: f,
                time: fs.statSync(path.join(reportsDir, f)).mtime.getTime()
              }))
              .sort((a, b) => b.time - a.time);
            
            if (files.length === 0) {
              console.log('No report files found');
              return;
            }
            
            const latestFile = path.join(reportsDir, files[0].name);
            const reportData = JSON.parse(fs.readFileSync(latestFile, 'utf8'));
            
            // Find critical issues
            const criticalChecks = reportData.checks.filter(c => 
              c.status === 'CRITICAL' || c.status === 'ERROR'
            );
            
            if (criticalChecks.length === 0) {
              console.log('No critical issues found');
              return;
            }
            
            // Build issue body
            let issueBody = `# üö® Critical Issues Detected by Reality Agent\n\n`;
            issueBody += `**Timestamp:** ${reportData.timestamp}\n`;
            issueBody += `**Overall Status:** ${reportData.overall_status}\n\n`;
            issueBody += `---\n\n`;
            issueBody += `## Critical Issues\n\n`;
            
            for (const check of criticalChecks) {
              issueBody += `### üö® ${check.name}\n\n`;
              issueBody += `**Status:** ${check.status}\n`;
              issueBody += `**Confidence:** ${(check.confidence * 100).toFixed(0)}%\n`;
              issueBody += `**Message:** ${check.message}\n\n`;
              issueBody += `**Details:**\n\`\`\`json\n${JSON.stringify(check.details, null, 2)}\n\`\`\`\n\n`;
            }
            
            issueBody += `---\n\n`;
            issueBody += `## Workflow Information\n\n`;
            issueBody += `- **Run ID:** ${context.runId}\n`;
            issueBody += `- **Run Number:** ${context.runNumber}\n`;
            issueBody += `- **Workflow:** [View Results](${context.payload.repository.html_url}/actions/runs/${context.runId})\n`;
            issueBody += `- **Report:** \`${files[0].name}\`\n\n`;
            issueBody += `---\n\n`;
            issueBody += `*This issue was automatically created by the Reality Agent using "Reality Glasses" philosophy.* ü•Ω‚ú®\n`;
            
            // Check if similar issue already exists (open issues with same label)
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'reality-check'
            });
            
            // Only create if no open reality-check issue exists
            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üö® Reality Check: Critical Issues Detected`,
                body: issueBody,
                labels: ['bug', 'reality-check', 'automated']
              });
              console.log('Created new issue for critical problems');
            } else {
              console.log('Open reality-check issue already exists, skipping creation');
              
              // Add a comment to existing issue instead
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssues.data[0].number,
                body: `## üîÑ New Critical Issues Detected\n\n${issueBody}`
              });
              console.log('Added comment to existing issue');
            }
      
      - name: ‚úÖ Success Summary
        if: steps.reality-check.outputs.exit_code == '0'
        run: |
          echo "‚úÖ Reality Check completed successfully"
          echo "Status: ${{ steps.reality-check.outputs.overall_status }}"
          echo "All checks passed or returned warnings only"
      
      - name: ‚ùå Failure Summary
        if: steps.reality-check.outputs.exit_code != '0'
        run: |
          echo "‚ùå Reality Check detected critical issues"
          echo "Status: ${{ steps.reality-check.outputs.overall_status }}"
          echo "Review the summary above for details"
          exit 1
