name: üöÇ Deploy to Railway

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

jobs:
  deploy:
    name: Railway Production Deployment
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Railway CLI
        run: |
          npm install -g @railway/cli@3.2.0
          railway --version
      
      - name: Mask Railway Token
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "::add-mask::$RAILWAY_TOKEN"
          echo "‚úÖ Railway token masked in logs"
      
      - name: Save Current Deployment State
        id: pre-deploy
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          CURRENT_ID=$(railway status --json 2>/dev/null | jq -r '.deploymentId // "none"')
          echo "previous_deployment=$CURRENT_ID" >> $GITHUB_OUTPUT
          echo "üì¶ Previous deployment: $CURRENT_ID"
      
      - name: Deploy to Railway
        id: deploy
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway up --service umaja-core
          NEW_ID=$(railway status --json | jq -r '.deploymentId')
          echo "new_deployment=$NEW_ID" >> $GITHUB_OUTPUT
          echo "üöÄ New deployment: $NEW_ID"
      
      - name: Health Check with Retry
        id: health
        run: |
          echo "üè• Starting health checks..."
          BACKEND_URL="https://umaja-core-production.up.railway.app"
          
          for i in {1..10}; do
            echo "Attempt $i/10..."
            
            if curl -f --max-time 10 "$BACKEND_URL/health"; then
              echo "‚úÖ Health check passed!"
              exit 0
            fi
            
            echo "‚è≥ Waiting 10s before retry..."
            sleep 10
          done
          
          echo "‚ùå Health check failed after 10 attempts"
          exit 1
      
      - name: Rollback on Failure
        if: failure() && steps.pre-deploy.outputs.previous_deployment != 'none'
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "üîÑ Rolling back to ${{ steps.pre-deploy.outputs.previous_deployment }}"
          railway rollback ${{ steps.pre-deploy.outputs.previous_deployment }}
          
          echo "‚è≥ Waiting 15s for rollback..."
          sleep 15
          
          curl -f https://umaja-core-production.up.railway.app/health || \
            echo "‚ö†Ô∏è Rollback health check failed!"
      
      - name: Notify Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Railway Deployment Failed - Rollback Triggered',
              body: `## Deployment Failure Report
              
              **Date:** ${new Date().toISOString()}
              **Workflow:** [${context.workflow}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              
              ### Details
              - **Previous Deployment:** ${{ steps.pre-deploy.outputs.previous_deployment }}
              - **Failed Deployment:** ${{ steps.deploy.outputs.new_deployment }}
              - **Rollback Status:** ${context.job.status}
              
              ### Next Steps
              1. Check Railway logs: https://railway.app/project/${process.env.RAILWAY_PROJECT_ID}
              2. Review workflow logs: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              3. Manual intervention may be required
              
              @${context.actor} please investigate.`,
              labels: ['deployment', 'critical', 'railway']
            });
