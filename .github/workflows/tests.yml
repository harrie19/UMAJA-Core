name:  UMAJA Core Tests

on:
  push: 
    branches: [ main ]
    paths:
      - 'src/**'
      - 'api/**'
      - 'tests/**'
      - 'requirements.txt'
      - '.github/workflows/tests.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'api/**'
      - 'tests/**'
      - 'requirements.txt'
      - '.github/workflows/tests.yml'
  workflow_dispatch: 

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.11']
    
    steps:
      - name:  ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ¤— Cache Hugging Face models
        uses: actions/cache@v4
        with:
          path: ~/.cache/huggingface
          key: ${{ runner.os }}-huggingface-models-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-huggingface-models-

      - name: ğŸ“¥ Pre-download Hugging Face models
        run: |
          python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('all-MiniLM-L6-v2')"
          python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('sentence-transformers/all-mpnet-base-v2')"
      
      - name:  ğŸ§ª Test RauschenGenerator
        run:  |
          python << 'PYTHON_SCRIPT'
          import sys
          sys.path.insert(0, '.')
          
          print("="*60)
          print("ğŸ¨ Testing RauschenGenerator")
          print("="*60)
          
          from src.rauschen_generator import RauschenGenerator
          
          print("1ï¸âƒ£ Testing instantiation...")
          generator = RauschenGenerator()
          print("   âœ… RauschenGenerator created successfully")
          
          print("2ï¸âƒ£ Testing short text generation...")
          result_short = generator.generate_reflection('test topic', 'short', 0.3)
          assert result_short['text'], "Short text is empty"
          assert result_short['word_count'] > 0, "Word count is zero"
          assert 50 <= result_short['word_count'] <= 150, f"Word count {result_short['word_count']} out of range"
          print(f"   âœ… Generated {result_short['word_count']} words (short)")
          
          print("3ï¸âƒ£ Testing long text generation...")
          result_long = generator.generate_reflection('test topic', 'long', 0.3)
          assert result_long['text'], "Long text is empty"
          assert 200 <= result_long['word_count'] <= 500, f"Word count {result_long['word_count']} out of range"
          print(f"   âœ… Generated {result_long['word_count']} words (long)")
          
          print("4ï¸âƒ£ Testing different noise levels...")
          for noise in [0.0, 0.5, 1.0]: 
              result = generator.generate_reflection('test', 'short', noise)
              assert result['metadata']['noise_level'] == noise, f"Noise level mismatch"
              print(f"   âœ… Noise level {noise} works")
          
          print("5ï¸âƒ£ Testing metadata...")
          assert 'text_id' in result_short, "Missing text_id"
          assert 'timestamp' in result_short, "Missing timestamp"
          assert 'price' in result_short, "Missing price"
          assert result_short['price'] > 0, "Price is not positive"
          print(f"   âœ… Metadata complete (price:  ${result_short['price']})")
          
          print()
          print("âœ… All RauschenGenerator tests passed!")
          print()
          PYTHON_SCRIPT
      
      - name: ğŸ” Test VektorAnalyzer
        run: |
          python << 'PYTHON_SCRIPT'
          import sys
          sys.path.insert(0, '.')
          
          print("="*60)
          print("ğŸ” Testing VektorAnalyzer")
          print("="*60)
          
          from src.vektor_analyzer import VektorAnalyzer
          
          print("1ï¸âƒ£ Testing instantiation...")
          analyzer = VektorAnalyzer()
          print("   âœ… VektorAnalyzer created successfully")
          
          print("2ï¸âƒ£ Testing coherence analysis...")
          test_text = "Artificial intelligence is transforming technology.  Machine learning enables computers to learn from data. This revolution is changing how we work."
          test_theme = "artificial intelligence"
          
          analysis = analyzer.analyze_coherence(test_text, test_theme)
          assert 'quality' in analysis, "Missing quality field"
          assert 'theme_similarity' in analysis, "Missing theme_similarity"
          assert 'avg_inter_sentence_coherence' in analysis, "Missing coherence"
          assert 'overall_score' in analysis, "Missing overall_score"
          print(f"   âœ… Analysis complete (quality: {analysis['quality']})")
          
          print("3ï¸âƒ£ Testing quality score ranges...")
          assert 0 <= analysis['theme_similarity'] <= 1, "Theme similarity out of range"
          assert 0 <= analysis['overall_score'] <= 1, "Overall score out of range"
          print(f"   âœ… Scores in valid range")
          print(f"      - Theme: {analysis['theme_similarity']:.3f}")
          print(f"      - Overall: {analysis['overall_score']:.3f}")
          
          print("4ï¸âƒ£ Testing text comparison...")
          text1 = "AI is powerful"
          text2 = "Artificial intelligence has great potential"
          similarity = analyzer.compare_texts(text1, text2)
          assert 0 <= similarity <= 1, "Similarity out of range"
          print(f"   âœ… Comparison works (similarity: {similarity:.3f})")
          
          print()
          print("âœ… All VektorAnalyzer tests passed!")
          print()
          PYTHON_SCRIPT
      
      - name: ğŸ’° Test DistributionEngine
        run: |
          python << 'PYTHON_SCRIPT'
          import sys
          sys.path.insert(0, '.')
          
          print("="*60)
          print("ğŸ’° Testing DistributionEngine")
          print("="*60)
          
          from src.distribution_engine import DistributionEngine
          
          print("1ï¸âƒ£ Testing instantiation...")
          engine = DistributionEngine()
          print("   âœ… DistributionEngine created successfully")
          
          print("2ï¸âƒ£ Testing payment allocation...")
          allocation = engine.allocate_payment(10.0)
          
          assert allocation['charity'] == 4.0, f"Charity allocation wrong: {allocation['charity']}"
          assert allocation['operations'] == 3.0, f"Operations allocation wrong: {allocation['operations']}"
          assert allocation['upgrades'] == 3.0, f"Upgrades allocation wrong: {allocation['upgrades']}"
          
          total = allocation['charity'] + allocation['operations'] + allocation['upgrades']
          assert abs(total - 10.0) < 0.01, f"Total allocation wrong: {total}"
          
          print(f"   âœ… Allocation correct:")
          print(f"      - Charity (40%): â‚¬{allocation['charity']:.2f}")
          print(f"      - Operations (30%): â‚¬{allocation['operations']:.2f}")
          print(f"      - Upgrades (30%): â‚¬{allocation['upgrades']:.2f}")
          
          print("3ï¸âƒ£ Testing different payment amounts...")
          for amount in [5.0, 100.0, 1000.0]:
              alloc = engine.allocate_payment(amount)
              expected_charity = amount * 0.4
              assert abs(alloc['charity'] - expected_charity) < 0.01, f"Wrong charity for {amount}"
              print(f"   âœ… â‚¬{amount} â†’ Charity: â‚¬{alloc['charity']:.2f}")
          
          print()
          print("âœ… All DistributionEngine tests passed!")
          print()
          PYTHON_SCRIPT
      
      - name: ğŸ”— Integration Test
        run: |
          python << 'PYTHON_SCRIPT'
          import sys
          sys.path.insert(0, '.')
          
          print("="*60)
          print("ğŸ”— Integration Test")
          print("="*60)
          
          from src.rauschen_generator import RauschenGenerator
          from src.vektor_analyzer import VektorAnalyzer
          from src.distribution_engine import DistributionEngine
          
          print("Testing full pipeline...")
          print()
          
          print("1ï¸âƒ£ Generating text...")
          generator = RauschenGenerator()
          result = generator.generate_reflection('integration test', 'short', 0.4)
          print(f"   âœ… Generated {result['word_count']} words")
          
          print("2ï¸âƒ£ Analyzing quality...")
          analyzer = VektorAnalyzer()
          analysis = analyzer.analyze_coherence(result['text'], 'integration test')
          print(f"   âœ… Quality: {analysis['quality']} (score: {analysis['overall_score']:.3f})")
          
          print("3ï¸âƒ£ Calculating distribution...")
          engine = DistributionEngine()
          allocation = engine.allocate_payment(result['price'])
          print(f"   âœ… Price: ${result['price']} â†’ Charity: ${allocation['charity']:.2f}")
          
          assert result['text'], "Text generation failed"
          assert analysis['quality'] in ['excellent', 'good', 'acceptable'], "Invalid quality"
          assert allocation['charity'] > 0, "Charity allocation failed"
          
          print()
          print("="*60)
          print("âœ… INTEGRATION TEST PASSED")
          print("="*60)
          print()
          print("Summary:")
          print(f"  ğŸ“ Text: {result['word_count']} words")
          print(f"  ğŸ¯ Quality: {analysis['quality']}")
          print(f"  ğŸ’° Price: ${result['price']}")
          print(f"  ğŸ Charity: ${allocation['charity']:.2f}")
          print()
          PYTHON_SCRIPT
      
      - name: ğŸ“Š Test Summary
        run:  |
          echo "================================"
          echo "âœ… ALL TESTS PASSED"
          echo "================================"
          echo ""
          echo "Components tested:"
          echo "  âœ… RauschenGenerator (text generation)"
          echo "  âœ… VektorAnalyzer (quality analysis)"
          echo "  âœ… DistributionEngine (fund allocation)"
          echo "  âœ… Integration (full pipeline)"
          echo ""
          echo "Python version: ${{ matrix.python-version }}"
          echo "Status: Ready for production"
