name: Text Generation Workflow

on:
  workflow_dispatch:
    inputs:
      topic:
        description: 'Topic for text generation'
        required: true
        default: 'artificial intelligence'
        type: string
      length:
        description: 'Length of generated text'
        required: true
        default: 'short'
        type: choice
        options:
          - short
          - long
      noise_level:
        description: 'Noise level (0.0-1.0)'
        required: true
        default: '0.3'
        type: string

permissions:
  contents: read
  actions: read

jobs:
  generate-text:
    name: Generate Text with Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: âœ… Validate inputs
        env:
          INPUT_TOPIC: ${{ github.event.inputs.topic }}
          INPUT_LENGTH: ${{ github.event.inputs.length }}
          INPUT_NOISE_LEVEL: ${{ github.event.inputs.noise_level }}
        run: |
          python << 'PYTHON_SCRIPT'
          import sys
          import os
          
          topic = os.environ['INPUT_TOPIC']
          noise_level = os.environ['INPUT_NOISE_LEVEL']
          length = os.environ['INPUT_LENGTH']
          
          # Validate topic length (1-200 chars)
          if len(topic) < 1 or len(topic) > 200:
              print(f"âŒ Error: Topic length must be between 1-200 characters (got {len(topic)})")
              sys.exit(1)
          
          print(f"âœ… Topic length valid: {len(topic)} characters")
          
          # Validate noise_level (0.0-1.0)
          try:
              noise = float(noise_level)
              if noise < 0.0 or noise > 1.0:
                  print(f"âŒ Error: Noise level must be between 0.0-1.0 (got {noise})")
                  sys.exit(1)
              print(f"âœ… Noise level valid: {noise}")
          except ValueError:
              print(f"âŒ Error: Noise level must be a number (got '{noise_level}')")
              sys.exit(1)
          
          print()
          print("="*60)
          print("ğŸ“‹ Generation Parameters")
          print("="*60)
          print(f"Topic: {topic}")
          print(f"Length: {length}")
          print(f"Noise Level: {noise}")
          print("="*60)
          print()
          PYTHON_SCRIPT
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ“ Create output directory
        run: |
          mkdir -p output/text_generation
      
      - name: ğŸ¨ Generate text using RauschenGenerator
        id: generate
        env:
          INPUT_TOPIC: ${{ github.event.inputs.topic }}
          INPUT_LENGTH: ${{ github.event.inputs.length }}
          INPUT_NOISE_LEVEL: ${{ github.event.inputs.noise_level }}
        run: |
          python << 'PYTHON_SCRIPT'
          import sys
          import json
          import os
          sys.path.insert(0, '.')
          
          from src.rauschen_generator import RauschenGenerator
          
          print("="*60)
          print("ğŸ¨ Generating Text with RauschenGenerator")
          print("="*60)
          print()
          
          # Parse inputs from environment
          topic = os.environ['INPUT_TOPIC']
          length = os.environ['INPUT_LENGTH']
          noise_level = float(os.environ['INPUT_NOISE_LEVEL'])
          
          # Initialize generator
          print("Initializing RauschenGenerator...")
          generator = RauschenGenerator()
          print("âœ… Generator initialized")
          print()
          
          # Generate text
          print(f"Generating {length} text about: {topic}")
          print(f"Noise level: {noise_level}")
          print()
          
          result = generator.generate_reflection(
              topic=topic,
              length=length,
              noise_level=noise_level
          )
          
          print("âœ… Text generation complete!")
          print()
          print(f"ğŸ“Š Generation Stats:")
          print(f"   - Text ID: {result['text_id']}")
          print(f"   - Word Count: {result['word_count']}")
          print(f"   - Price: ${result['price']}")
          print(f"   - Coherence Score: {result['metadata']['coherence_score']}")
          print(f"   - Timestamp: {result['timestamp']}")
          print()
          
          # Save result for next step
          with open('output/text_generation/generation_result.json', 'w') as f:
              json.dump(result, f, indent=2)
          
          print("âœ… Result saved to generation_result.json")
          print()
          PYTHON_SCRIPT
      
      - name: ğŸ” Analyze quality using VektorAnalyzer
        env:
          INPUT_TOPIC: ${{ github.event.inputs.topic }}
        run: |
          python << 'PYTHON_SCRIPT'
          import sys
          import json
          import os
          sys.path.insert(0, '.')
          
          from src.vektor_analyzer import VektorAnalyzer
          
          print("="*60)
          print("ğŸ” Analyzing Text Quality")
          print("="*60)
          print()
          
          # Load generation result
          with open('output/text_generation/generation_result.json', 'r') as f:
              result = json.load(f)
          
          # Initialize analyzer
          print("Initializing VektorAnalyzer...")
          analyzer = VektorAnalyzer()
          print("âœ… Analyzer initialized")
          print()
          
          # Analyze coherence
          topic = os.environ['INPUT_TOPIC']
          text = result['text']
          
          print(f"Analyzing coherence with theme: {topic}")
          analysis = analyzer.analyze_coherence(text, topic)
          
          print()
          print("ğŸ“Š Quality Analysis Results:")
          print(f"   - Quality Rating: {analysis['quality']}")
          print(f"   - Theme Similarity: {analysis['theme_similarity']:.3f}")
          print(f"   - Inter-sentence Coherence: {analysis['avg_inter_sentence_coherence']:.3f}")
          print(f"   - Overall Score: {analysis['overall_score']:.3f}")
          print()
          
          # Add analysis to result
          result['quality_analysis'] = analysis
          
          # Save updated result
          with open('output/text_generation/generation_result.json', 'w') as f:
              json.dump(result, f, indent=2)
          
          print("âœ… Quality analysis complete!")
          print()
          PYTHON_SCRIPT
      
      - name: ğŸ’¾ Save results to files
        env:
          INPUT_TOPIC: ${{ github.event.inputs.topic }}
          INPUT_LENGTH: ${{ github.event.inputs.length }}
          INPUT_NOISE_LEVEL: ${{ github.event.inputs.noise_level }}
        run: |
          python << 'PYTHON_SCRIPT'
          import sys
          import json
          import os
          sys.path.insert(0, '.')
          
          print("="*60)
          print("ğŸ’¾ Saving Results")
          print("="*60)
          print()
          
          # Load result
          with open('output/text_generation/generation_result.json', 'r') as f:
              result = json.load(f)
          
          # Get inputs from environment
          topic = os.environ['INPUT_TOPIC']
          length = os.environ['INPUT_LENGTH']
          noise_level = os.environ['INPUT_NOISE_LEVEL']
          
          # Save JSON output
          with open('output/text_generation/generated_text_output.json', 'w') as f:
              json.dump(result, f, indent=2)
          print("âœ… Saved: generated_text_output.json")
          
          # Save text-only output
          with open('output/text_generation/generated_text.txt', 'w') as f:
              f.write("="*60 + "\n")
              f.write("UMAJA-Core Generated Text\n")
              f.write("="*60 + "\n\n")
              f.write(f"Topic: {topic}\n")
              f.write(f"Length: {length}\n")
              f.write(f"Noise Level: {noise_level}\n")
              f.write(f"Word Count: {result['word_count']}\n")
              f.write(f"Quality: {result['quality_analysis']['quality']}\n")
              f.write(f"Overall Score: {result['quality_analysis']['overall_score']:.3f}\n")
              f.write("\n" + "="*60 + "\n")
              f.write("GENERATED TEXT\n")
              f.write("="*60 + "\n\n")
              f.write(result['text'])
              f.write("\n\n" + "="*60 + "\n")
              f.write("METADATA\n")
              f.write("="*60 + "\n\n")
              f.write(f"Text ID: {result['text_id']}\n")
              f.write(f"Timestamp: {result['timestamp']}\n")
              f.write(f"Price: ${result['price']}\n")
              f.write(f"Coherence Score: {result['metadata']['coherence_score']}\n")
              f.write(f"Theme Similarity: {result['quality_analysis']['theme_similarity']:.3f}\n")
              f.write(f"Inter-sentence Coherence: {result['quality_analysis']['avg_inter_sentence_coherence']:.3f}\n")
          
          print("âœ… Saved: generated_text.txt")
          print()
          PYTHON_SCRIPT
      
      - name: ğŸ“Š Display results summary
        env:
          INPUT_TOPIC: ${{ github.event.inputs.topic }}
          INPUT_LENGTH: ${{ github.event.inputs.length }}
          INPUT_NOISE_LEVEL: ${{ github.event.inputs.noise_level }}
        run: |
          python << 'PYTHON_SCRIPT'
          import sys
          import json
          import os
          
          # Load result
          with open('output/text_generation/generation_result.json', 'r') as f:
              result = json.load(f)
          
          # Get inputs from environment
          topic = os.environ['INPUT_TOPIC']
          length = os.environ['INPUT_LENGTH']
          noise_level = os.environ['INPUT_NOISE_LEVEL']
          
          print()
          print("="*60)
          print("ğŸ“Š GENERATION SUMMARY")
          print("="*60)
          print()
          print(f"Topic: {topic}")
          print(f"Length: {length}")
          print(f"Noise Level: {noise_level}")
          print()
          print("Generated Text Stats:")
          print(f"  ğŸ“ Word Count: {result['word_count']}")
          print(f"  ğŸ’° Price: ${result['price']}")
          print(f"  ğŸ†” Text ID: {result['text_id']}")
          print()
          print("Quality Analysis:")
          print(f"  ğŸ¯ Quality Rating: {result['quality_analysis']['quality']}")
          print(f"  ğŸ“Š Overall Score: {result['quality_analysis']['overall_score']:.3f}")
          print(f"  ğŸ¨ Theme Similarity: {result['quality_analysis']['theme_similarity']:.3f}")
          print(f"  ğŸ”— Inter-sentence Coherence: {result['quality_analysis']['avg_inter_sentence_coherence']:.3f}")
          print()
          print("="*60)
          print()
          print("Preview (first 200 characters):")
          print("-" * 60)
          preview = result['text'][:200]
          print(preview + ("..." if len(result['text']) > 200 else ""))
          print("-" * 60)
          print()
          print("âœ… Text generation and analysis complete!")
          print("ğŸ“¦ Download artifacts to view full results")
          print()
          PYTHON_SCRIPT
      
      - name: ğŸ“¦ Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: generated-text-${{ github.run_number }}
          path: |
            output/text_generation/generated_text_output.json
            output/text_generation/generated_text.txt
          retention-days: 30
      
      - name: âœ… Workflow complete
        if: success()
        run: |
          echo "ğŸ‰ Text generation workflow completed successfully!"
          echo ""
          echo "ğŸ“¦ Artifacts have been uploaded and will be retained for 30 days."
          echo ""
          echo "To download the results:"
          echo "1. Go to the 'Summary' tab of this workflow run"
          echo "2. Find 'Artifacts' section at the bottom"
          echo "3. Download 'generated-text-${{ github.run_number }}'"
          echo ""
          echo "Files included:"
          echo "  - generated_text_output.json (full metadata and analysis)"
          echo "  - generated_text.txt (human-readable format)"
