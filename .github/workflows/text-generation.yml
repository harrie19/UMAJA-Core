name: ğŸ¨ On-Demand Text Generation

on:
  workflow_dispatch:
    inputs:
      topic:
        description: 'The topic for text generation'
        required: true
        type: string
      length:
        description: 'Length of generated text'
        required: true
        type: choice
        options:
          - short
          - medium
          - long
        default: medium
      noise_level:
        description: 'Noise level for generation (0.0-1.0)'
        required: true
        type: number
        default: 0.5

jobs:
  generate-text:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ¨ Generate Text
        id: generate
        run: |
          python << 'PYTHON_SCRIPT'
          import sys
          import json
          import os
          sys.path.insert(0, '.')
          
          from src.rauschen_generator import RauschenGenerator
          from src.vektor_analyzer import VektorAnalyzer
          from src.distribution_engine import DistributionEngine
          
          # Get inputs
          topic = "${{ github.event.inputs.topic }}"
          length_input = "${{ github.event.inputs.length }}"
          noise_level = float("${{ github.event.inputs.noise_level }}")
          
          # Map medium to short (RauschenGenerator only supports short/long)
          length = 'short' if length_input == 'medium' else length_input
          
          print("="*70)
          print("ğŸ¨ UMAJA-Core Text Generation")
          print("="*70)
          print(f"Topic: {topic}")
          print(f"Length: {length_input}")
          print(f"Noise Level: {noise_level}")
          print()
          
          # Initialize components
          print("1ï¸âƒ£ Initializing components...")
          generator = RauschenGenerator()
          analyzer = VektorAnalyzer()
          engine = DistributionEngine()
          print("   âœ… Components initialized")
          print()
          
          # Generate text
          print("2ï¸âƒ£ Generating text...")
          result = generator.generate_reflection(topic, length, noise_level)
          print(f"   âœ… Generated {result['word_count']} words")
          print()
          
          # Analyze quality
          print("3ï¸âƒ£ Analyzing quality...")
          analysis = analyzer.analyze_coherence(result['text'], topic)
          print(f"   âœ… Quality: {analysis['quality']}")
          print(f"   ğŸ“Š Theme Similarity: {analysis['theme_similarity']:.3f}")
          print(f"   ğŸ“Š Coherence: {analysis['avg_inter_sentence_coherence']:.3f}")
          print(f"   ğŸ“Š Overall Score: {analysis['overall_score']:.3f}")
          print()
          
          # Calculate distribution
          print("4ï¸âƒ£ Calculating fund distribution...")
          allocation = engine.allocate_payment(result['price'])
          print(f"   ğŸ’° Price: ${result['price']}")
          print(f"   ğŸ Charity (40%): ${allocation['charity']:.2f}")
          print(f"   ğŸ”§ Operations (30%): ${allocation['operations']:.2f}")
          print(f"   ğŸš€ Upgrades (30%): ${allocation['upgrades']:.2f}")
          print()
          
          # Save results
          print("5ï¸âƒ£ Saving results...")
          output = {
              "generation": {
                  "text": result['text'],
                  "text_id": result['text_id'],
                  "word_count": result['word_count'],
                  "timestamp": result['timestamp'],
                  "metadata": result['metadata']
              },
              "quality_analysis": analysis,
              "pricing": {
                  "price": result['price'],
                  "allocation": allocation
              },
              "inputs": {
                  "topic": topic,
                  "length": length_input,
                  "noise_level": noise_level
              }
          }
          
          # Write to file
          with open('generated_text.json', 'w') as f:
              json.dump(output, f, indent=2)
          
          # Also write readable text file
          with open('generated_text.txt', 'w') as f:
              f.write("="*70 + "\n")
              f.write("UMAJA-Core Generated Text\n")
              f.write("="*70 + "\n\n")
              f.write(f"Topic: {topic}\n")
              f.write(f"Length: {length_input}\n")
              f.write(f"Noise Level: {noise_level}\n")
              f.write(f"Generated: {result['timestamp']}\n")
              f.write(f"Text ID: {result['text_id']}\n")
              f.write("\n" + "-"*70 + "\n")
              f.write("GENERATED TEXT\n")
              f.write("-"*70 + "\n\n")
              f.write(result['text'])
              f.write("\n\n" + "-"*70 + "\n")
              f.write("QUALITY ANALYSIS\n")
              f.write("-"*70 + "\n\n")
              f.write(f"Quality Rating: {analysis['quality']}\n")
              f.write(f"Theme Similarity: {analysis['theme_similarity']:.3f}\n")
              f.write(f"Inter-Sentence Coherence: {analysis['avg_inter_sentence_coherence']:.3f}\n")
              f.write(f"Overall Score: {analysis['overall_score']:.3f}\n")
              f.write(f"\nWord Count: {result['word_count']}\n")
              f.write(f"Coherence Score: {result['metadata']['coherence_score']:.3f}\n")
              f.write("\n" + "-"*70 + "\n")
              f.write("PRICING & DISTRIBUTION\n")
              f.write("-"*70 + "\n\n")
              f.write(f"Price: ${result['price']}\n")
              f.write(f"Charity (40%): ${allocation['charity']:.2f}\n")
              f.write(f"Operations (30%): ${allocation['operations']:.2f}\n")
              f.write(f"Upgrades (30%): ${allocation['upgrades']:.2f}\n")
          
          print(f"   âœ… Results saved to generated_text.json and generated_text.txt")
          print()
          
          print("="*70)
          print("âœ… TEXT GENERATION COMPLETE")
          print("="*70)
          print()
          print(f"ğŸ“ Generated {result['word_count']} words")
          print(f"ğŸ¯ Quality: {analysis['quality']} (score: {analysis['overall_score']:.3f})")
          print(f"ğŸ’° Price: ${result['price']}")
          print(f"ğŸ Charity contribution: ${allocation['charity']:.2f}")
          print()
          PYTHON_SCRIPT
      
      - name: ğŸ“¦ Upload Generated Text
        uses: actions/upload-artifact@v4
        with:
          name: generated-text-${{ github.run_number }}
          path: |
            generated_text.json
            generated_text.txt
          retention-days: 30
      
      - name: ğŸ“Š Generation Summary
        run: |
          echo "## ğŸ¨ Text Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Input Parameters" >> $GITHUB_STEP_SUMMARY
          echo "- **Topic:** ${{ github.event.inputs.topic }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Length:** ${{ github.event.inputs.length }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Noise Level:** ${{ github.event.inputs.noise_level }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Text generation completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“¦ **Artifacts:** Download the generated text from the artifacts section above." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The generated text includes:" >> $GITHUB_STEP_SUMMARY
          echo "- Generated reflection text" >> $GITHUB_STEP_SUMMARY
          echo "- Quality analysis (theme similarity, coherence scores)" >> $GITHUB_STEP_SUMMARY
          echo "- Pricing information" >> $GITHUB_STEP_SUMMARY
          echo "- Fund distribution breakdown (40% charity, 30% operations, 30% upgrades)" >> $GITHUB_STEP_SUMMARY
