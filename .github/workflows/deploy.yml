name: Deploy UMAJA WORLDTOUR

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Deployment platform'
        required: true
        default: 'railway'
        type: choice
        options:
          - railway
          - heroku
      environment:
        description: 'Environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'api/**'
      - 'requirements.txt'
      - 'Procfile'
      - 'railway.json'

jobs:
  deploy-railway:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.platform == 'railway' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸš‚ Deploy to Railway
        uses: bervProject/railway-deploy@main
        with:
          railway_token: ${{ secrets.RAILWAY_TOKEN }}
          service: umaja-worldtour
        env:
          ENVIRONMENT: ${{ github.event.inputs.environment || 'production' }}
      
      - name: âœ… Deployment complete
        run: |
          echo "ðŸŽ‰ Deployment to Railway completed!"
          echo "Platform: Railway"
          echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "Branch: ${{ github.ref_name }}"

  deploy-heroku:
    name: Deploy to Heroku
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.platform == 'heroku'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸš€ Deploy to Heroku
        uses: akhileshns/heroku-deploy@v3.13.15
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: ${{ secrets.HEROKU_APP_NAME }}
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
          branch: ${{ github.ref_name }}
        env:
          HD_ENVIRONMENT: ${{ github.event.inputs.environment || 'production' }}
          HD_SALES_ENABLED: "true"
          HD_WORLDTOUR_MODE: "true"
      
      - name: âœ… Deployment complete
        run: |
          echo "ðŸŽ‰ Deployment to Heroku completed!"
          echo "Platform: Heroku"
          echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "App: ${{ secrets.HEROKU_APP_NAME }}"

  test-before-deploy:
    name: Run Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ§ª Test personality engine
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'src')
          from personality_engine import PersonalityEngine
          engine = PersonalityEngine()
          result = engine.generate_text('test', 'john_cleese', 'short')
          assert result['text'], 'Text generation failed'
          print('âœ… PersonalityEngine test passed')
          "
      
      - name: ðŸŒ Test worldtour generator
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'src')
          from worldtour_generator import WorldtourGenerator
          gen = WorldtourGenerator()
          stats = gen.get_stats()
          assert stats['total_cities'] > 0, 'No cities loaded'
          print(f'âœ… WorldtourGenerator test passed ({stats[\"total_cities\"]} cities)')
          "
      
      - name: ðŸ’° Test bundle builder
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'src')
          from bundle_builder import BundleBuilder
          builder = BundleBuilder()
          pricing = builder.calculate_bundle_price(['standard_bundle'])
          assert pricing['total'] > 0, 'Pricing calculation failed'
          print(f'âœ… BundleBuilder test passed (â‚¬{pricing[\"total\"]:.2f})')
          "
      
      - name: âœ… Tests complete
        run: echo "ðŸŽ‰ All tests passed - ready for deployment!"

  notify:
    name: Send notification
    runs-on: ubuntu-latest
    needs: [deploy-railway, deploy-heroku]
    if: always() && (needs.deploy-railway.result == 'success' || needs.deploy-heroku.result == 'success')
    
    steps:
      - name: ðŸ“¢ Deployment notification
        run: |
          echo "ðŸŽ­ UMAJA WORLDTOUR Deployment Complete!"
          echo "=================================="
          echo "Status: SUCCESS âœ…"
          echo "Time: $(date)"
          echo "Commit: ${{ github.sha }}"
          echo "=================================="
