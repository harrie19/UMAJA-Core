name: Daily Worldtour Content

on:
  # Scheduled daily at 12:00 UTC
  schedule:
    - cron: '0 12 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      city_id:
        description: 'Specific city ID (optional, leave empty for next in queue)'
        required: false
        type: string
      personality:
        description: 'Specific personality (optional, leave empty for rotation)'
        required: false
        type: choice
        options:
          - ''
          - john_cleese
          - c3po
          - robin_williams

jobs:
  generate-content:
    name: Generate Daily Worldtour Content
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      actions: write
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ¬ Install FFmpeg (for video generation)
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
      
      - name: ğŸ“ Create output directories
        run: |
          mkdir -p output/worldtour
          mkdir -p data
          mkdir -p static/audio
          mkdir -p static/images
          mkdir -p static/videos
      
      - name: ğŸŒ Generate daily worldtour content
        run: |
          python scripts/daily_worldtour_post.py
        env:
          USE_OFFLINE_TTS: true
          WORLDTOUR_MODE: true
          WORLDTOUR_DAILY_POST: true
          SALES_ENABLED: false
      
      - name: ğŸ“Š Check worldtour progress
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'src')
          from worldtour_generator import WorldtourGenerator
          
          gen = WorldtourGenerator()
          stats = gen.get_stats()
          
          print('='*60)
          print('ğŸŒ WORLDTOUR PROGRESS')
          print('='*60)
          print(f'Visited: {stats[\"visited_cities\"]} / {stats[\"total_cities\"]} cities')
          print(f'Remaining: {stats[\"remaining_cities\"]} cities')
          print(f'Completion: {stats[\"completion_percentage\"]}%')
          print('='*60)
          "
      
      - name: ğŸ“¦ Upload generated content as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: worldtour-content-${{ github.run_number }}
          path: |
            output/worldtour/**/*
          retention-days: 30
      
      - name: ğŸ“¦ Upload state file
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: worldtour-state-${{ github.run_number }}
          path: |
            data/worldtour_*.json
          retention-days: 90
      
      - name: âœ… Generation complete
        if: success()
        run: |
          echo "ğŸ‰ Daily worldtour content generated successfully!"
          echo ""
          echo "Next steps:"
          echo "1. Download the artifacts from this workflow run"
          echo "2. Review the generated content"
          echo "3. Upload video to TikTok, YouTube Shorts, Instagram Reels"
          echo "4. Post teaser on Twitter with hashtags #UMAJAWorldtour #AIComedy"
          echo "5. Create engagement poll: 'Which city next?'"
      
      - name: âŒ Generation failed
        if: failure()
        run: |
          echo "âŒ Content generation failed. Please check the logs above."
          exit 1
  
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: generate-content
    if: always()
    
    permissions:
      contents: read
    
    steps:
      - name: ğŸ“¢ Success notification
        if: needs.generate-content.result == 'success'
        run: |
          echo "ğŸ­ Daily UMAJA Worldtour content is ready!"
          echo "Download artifacts and upload to social media."
      
      - name: ğŸ“¢ Failure notification
        if: needs.generate-content.result == 'failure'
        run: |
          echo "âš ï¸ Daily content generation failed."
          echo "Please investigate the workflow logs."
