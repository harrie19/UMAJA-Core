name: Autonomous Content Cycle

on:
  # Run every 4 hours (6 times daily)
  schedule:
    - cron: '0 */4 * * *'
  
  # Allow manual triggering
  workflow_dispatch:

jobs:
  content-cycle:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“‹ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸš¨ Check Emergency Stop
        id: emergency_check
        run: |
          if [ -f .github/emergency_stop.json ]; then
            ENABLED=$(jq -r '.agent_enabled' .github/emergency_stop.json)
            echo "enabled=$ENABLED" >> $GITHUB_OUTPUT
            
            if [ "$ENABLED" != "true" ]; then
              echo "âŒ Emergency stop is active!"
              REASON=$(jq -r '.reason // "No reason specified"' .github/emergency_stop.json)
              echo "Reason: $REASON"
              exit 1
            fi
          else
            echo "enabled=true" >> $GITHUB_OUTPUT
          fi
          echo "âœ… Emergency stop check passed"
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ¥ System Health Check
        id: health_check
        run: |
          python3 << 'EOF'
          import json
          import sys
          from pathlib import Path
          
          print("ğŸ¥ Performing system health check...")
          
          # Check critical files exist
          critical_files = [
              'src/personality_engine.py',
              'src/vektor_analyzer.py',
              'src/worldtour_generator.py'
          ]
          
          for file in critical_files:
              if not Path(file).exists():
                  print(f"âŒ Critical file missing: {file}")
                  sys.exit(1)
          
          print("âœ… All critical files present")
          
          # Check data directory
          data_dir = Path('data')
          if not data_dir.exists():
              data_dir.mkdir(parents=True)
              print("ğŸ“ Created data directory")
          
          print("âœ… System health check passed")
          EOF
      
      - name: ğŸ˜Š Generate Daily Smiles - All Personalities
        run: |
          python3 << 'EOF'
          import json
          import sys
          from pathlib import Path
          from datetime import datetime
          
          sys.path.insert(0, 'src')
          from personality_engine import PersonalityEngine
          
          engine = PersonalityEngine()
          
          personalities = ['john_cleese', 'c3po', 'robin_williams']
          languages = ['en', 'es', 'hi', 'ar', 'zh', 'pt', 'fr', 'ru']
          
          results = []
          
          print("ğŸ˜Š Generating daily smiles...")
          print()
          
          for personality in personalities:
              print(f"ğŸ­ {personality.replace('_', ' ').title()}")
              
              for language in languages:
                  try:
                      smile = engine.generate_daily_smile(
                          personality=personality,
                          language=language
                      )
                      
                      results.append({
                          'personality': personality,
                          'language': language,
                          'content': smile.get('content', ''),
                          'timestamp': datetime.utcnow().isoformat()
                      })
                      
                      print(f"  âœ… {language.upper()}")
                  
                  except Exception as e:
                      print(f"  âŒ {language.upper()} - Error: {e}")
          
          print()
          print(f"âœ… Generated {len(results)} smiles")
          
          # Save results
          output_dir = Path('output/smiles')
          output_dir.mkdir(parents=True, exist_ok=True)
          
          timestamp = datetime.utcnow().strftime('%Y%m%d_%H%M%S')
          output_file = output_dir / f'smiles_{timestamp}.json'
          
          with open(output_file, 'w') as f:
              json.dump(results, f, indent=2, ensure_ascii=False)
          
          print(f"ğŸ’¾ Saved to: {output_file}")
          EOF
      
      - name: âœ… Run Quality Validation
        run: |
          python3 << 'EOF'
          import json
          import sys
          import glob
          from pathlib import Path
          
          sys.path.insert(0, 'src')
          from vektor_analyzer import VektorAnalyzer
          
          analyzer = VektorAnalyzer()
          
          print("âœ… Running quality validation...")
          print()
          
          # Find latest smiles file
          smile_files = sorted(Path('output/smiles').glob('smiles_*.json'))
          
          if not smile_files:
              print("âš ï¸  No smile files found")
              sys.exit(0)
          
          latest_file = smile_files[-1]
          
          with open(latest_file, 'r') as f:
              smiles = json.load(f)
          
          # Validate a sample
          sample_size = min(5, len(smiles))
          passed = 0
          failed = 0
          
          for smile in smiles[:sample_size]:
              content = smile['content']
              result = analyzer.analyze_coherence(content, "joy and positivity")
              
              if result['overall_score'] >= 0.3:
                  passed += 1
                  print(f"âœ… {smile['personality']}/{smile['language']}: {result['quality']} ({result['overall_score']:.2f})")
              else:
                  failed += 1
                  print(f"âŒ {smile['personality']}/{smile['language']}: {result['quality']} ({result['overall_score']:.2f})")
          
          print()
          print(f"Quality Check Results: {passed} passed, {failed} failed")
          
          if failed > passed:
              print("âŒ Quality validation failed!")
              sys.exit(1)
          else:
              print("âœ… Quality validation passed!")
          EOF
      
      - name: ğŸ“Š Collect Analytics Data
        run: |
          python3 << 'EOF'
          import json
          import glob
          from pathlib import Path
          from datetime import datetime
          
          print("ğŸ“Š Collecting analytics data...")
          
          # Count total smiles generated
          smile_files = list(Path('output/smiles').glob('smiles_*.json'))
          total_smiles = 0
          
          for file in smile_files:
              with open(file, 'r') as f:
                  data = json.load(f)
                  total_smiles += len(data)
          
          # Update analytics
          analytics_file = Path('data/analytics.json')
          
          if analytics_file.exists():
              with open(analytics_file, 'r') as f:
                  analytics = json.load(f)
          else:
              analytics = {
                  "total_smiles_generated": 0,
                  "content_cycles_completed": 0,
                  "last_cycle": None
              }
          
          analytics['content_cycles_completed'] += 1
          analytics['last_cycle'] = datetime.utcnow().isoformat()
          analytics['total_smile_files'] = len(smile_files)
          
          analytics_file.parent.mkdir(parents=True, exist_ok=True)
          with open(analytics_file, 'w') as f:
              json.dump(analytics, f, indent=2)
          
          print(f"âœ… Analytics updated")
          print(f"Total cycles: {analytics['content_cycles_completed']}")
          print(f"Smile files: {len(smile_files)}")
          EOF
      
      - name: ğŸ§  Learning and Optimization
        run: |
          python3 << 'EOF'
          import json
          from pathlib import Path
          
          print("ğŸ§  Analyzing performance for optimization...")
          
          # Load analytics
          analytics_file = Path('data/analytics.json')
          
          if analytics_file.exists():
              with open(analytics_file, 'r') as f:
                  analytics = json.load(f)
              
              cycles = analytics.get('content_cycles_completed', 0)
              
              # Simple optimization logic
              recommendations = []
              
              if cycles > 0 and cycles % 10 == 0:
                  recommendations.append("Consider reviewing content quality patterns")
              
              if cycles > 0 and cycles % 50 == 0:
                  recommendations.append("Milestone reached! Review overall system performance")
              
              if recommendations:
                  print("ğŸ’¡ Recommendations:")
                  for rec in recommendations:
                      print(f"  - {rec}")
              else:
                  print("âœ… System performing optimally")
          else:
              print("âš ï¸  No analytics data available yet")
          EOF
      
      - name: ğŸ’¾ Save State and Commit Updates
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add generated content and analytics
          git add output/smiles/ || true
          git add data/analytics.json || true
          git add data/agents/ || true
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            git commit -m "ğŸ¤– Content Cycle: Generated content at $TIMESTAMP [automated]"
            echo "âœ… Changes committed"
          fi
      
      - name: ğŸš€ Push Changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
      
      - name: ğŸ”„ Self-Heal on Failures
        if: failure()
        run: |
          echo "âš ï¸  Content cycle encountered an error"
          echo "ğŸ”„ Attempting self-healing..."
          
          python3 << 'EOF'
          import json
          from pathlib import Path
          from datetime import datetime
          
          # Log the failure
          error_log = Path('data/error_log.json')
          
          if error_log.exists():
              with open(error_log, 'r') as f:
                  log = json.load(f)
          else:
              log = {"errors": []}
          
          log['errors'].append({
              "timestamp": datetime.utcnow().isoformat(),
              "workflow": "content_cycle",
              "action": "self_heal_attempted"
          })
          
          error_log.parent.mkdir(parents=True, exist_ok=True)
          with open(error_log, 'w') as f:
              json.dump(log, f, indent=2)
          
          print("âœ… Error logged for future analysis")
          
          # Check if we should disable the system
          recent_errors = [e for e in log['errors'][-10:]]
          
          if len(recent_errors) >= 5:
              print("âš ï¸  Multiple recent failures detected")
              print("Consider reviewing the system")
          EOF
      
      - name: ğŸ“¢ Notify on Critical Failure
        if: failure()
        run: |
          echo "âŒ Content cycle failed!"
          echo "Check the logs for details."
          echo "System will retry on next scheduled run."
